name: Pages Build & Deployment

permissions:
  contents: write
  pages: write
  id-token: write

on:
  workflow_dispatch:

jobs:
  deploy-pages:
    name: Deploy Reports to GH Pages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout existing gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          token: ${{ secrets.GH_PAGES_TOKEN }}
          path: gh-pages

      - name: Get latest successful workflow run
        id: get_latest_run
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const workflow_name = "Playwright CI & Reports Build";
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflow_name,
              status: "success",
              per_page: 1
            });
            if (!runs.data.workflow_runs.length) {
              core.setFailed("No successful workflow runs found");
            } else {
              core.setOutput("run_id", runs.data.workflow_runs[0].id);
              core.setOutput("branch", runs.data.workflow_runs[0].head_branch);
            }

      - name: Download Allure report artifact
        uses: actions/download-artifact@v4
        with:
          name: allure-report
          path: allure-report
          repository: ${{ github.repository }}
          run-id: ${{ steps.get_latest_run.outputs.run_id }}

      - name: Download Playwright report artifact
        uses: actions/download-artifact@v4
        with:
          name: playwright-html-report
          path: playwright-report
          repository: ${{ github.repository }}
          run-id: ${{ steps.get_latest_run.outputs.run_id }}

      - name: Assemble site directory
        run: |
          set -e
          REF_NAME=${{ steps.get_latest_run.outputs.branch }}
          SITE_DIR=site
          mkdir -p $SITE_DIR/allure-reports/$REF_NAME
          mkdir -p $SITE_DIR/playwright-reports/$REF_NAME

          cp -r allure-report/* $SITE_DIR/allure-reports/$REF_NAME/ || true
          cp -r playwright-report/* $SITE_DIR/playwright-reports/$REF_NAME/ || true

          # Preserve Allure history
          if [[ -d gh-pages/allure-reports/latest/history ]]; then
            mkdir -p $SITE_DIR/allure-reports/$REF_NAME/history
            cp -r gh-pages/allure-reports/latest/history/* $SITE_DIR/allure-reports/$REF_NAME/history/ || true
          fi

          # Update 'latest' for master
          if [[ "$REF_NAME" == "master" ]]; then
            rm -rf $SITE_DIR/allure-reports/latest || true
            rm -rf $SITE_DIR/playwright-reports/latest || true
            cp -r $SITE_DIR/allure-reports/master $SITE_DIR/allure-reports/latest || true
            cp -r $SITE_DIR/playwright-reports/master $SITE_DIR/playwright-reports/latest || true
          fi

      - name: Generate index.html
        run: |
          chmod +x scripts/generate-index-html.sh
          cd site
          ../scripts/generate-index-html.sh

      - name: Publish site to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GH_PAGES_TOKEN }}
          publish_dir: site
          publish_branch: gh-pages
          keep_files: true
          user_name: github-actions[bot]
          user_email: github-actions[bot]@users.noreply.github.com

      - name: Comment on PR with workflow run link and reports
        if: ${{ github.event.pull_request }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ‚úÖ Playwright test run completed

            üîó CI Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ steps.get_latest_run.outputs.run_id }}

            üåê Allure report: https://${{ github.repository_owner }}.github.io/${{ github.repository }}/allure-reports/${{ steps.get_latest_run.outputs.branch }}
            üåü Allure (latest): https://${{ github.repository_owner }}.github.io/${{ github.repository }}/allure-reports/latest

            üåê Playwright report: https://${{ github.repository_owner }}.github.io/${{ github.repository }}/playwright-reports/${{ steps.get_latest_run.outputs.branch }}
            üåü Playwright (latest): https://${{ github.repository_owner }}.github.io/${{ github.repository }}/playwright-reports/latest
